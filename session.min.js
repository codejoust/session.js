/**
 * session.js 0.0.3
 * (c) 2012 Iain, CodeJoust
 * session is freely distributable under the MIT license.
 * Portions of session.js are inspired or borrowed from Underscore.js, and quirksmode.org demo javascript.
 * This version uses google's jsapi library for location services.
 * For details, see: https://github.com/codejoust/session.js
 */
(function(a,b){var c={use_html5_location:!1,ipinfodb_key:!1,gapi_location:!0,location_cookie:"location",location_cookie_timeout:2,session_timeout:32,session_cookie:"first_session"},d=function(){if(a.session&&a.session.options)for(option in a.session.options)c[option]=a.session.options[option];this.modules={api_version:.3,locale:f.locale(),current_session:f.session(),original_session:f.session(c.session_cookie,c.session_timeout*24*60*60*1e3),browser:f.browser(),plugins:f.plugins(),device:f.device()},c.use_html5_location?this.modules.location=f.html5_location():c.ipinfodb_key?this.modules.location=f.ipinfodb_location(c.ipinfodb_key):c.gapi_location&&(this.modules.location=f.gapi_location());if(a.session&&a.session.start)var b=a.session.start;var d=0,e,g,h=this,i=function(){d===0&&(a.session=h.modules,b&&b(h.modules))};for(var j in this.modules){e=h.modules[j];if(typeof e=="function")try{d++,e(function(a){h.modules[j]=a,d--,i()})}catch(k){console&&typeof console.log=="function"&&console.log(k)}else h.modules[j]=e}i()},e={detect:function(){return{browser:this.search(this.data.browser),version:this.search(navigator.userAgent)||this.search(navigator.appVersion),os:this.search(this.data.os)}},search:function(a){if(typeof a!="object"){var e=a.indexOf(this.version_string);if(e==-1)return;return parseFloat(a.substr(e+this.version_string.length+1))}for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;this.version_string=a[b].versionSearch||a[b].identity;if(c){if(c.indexOf(a[b].subString)!=-1)return a[b].identity}else if(d)return a[b].identity}},data:{browser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:a.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],os:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.userAgent,subString:"iPad",identitiy:"iPad"},{string:navigator.platform,subString:"Linux",identity:"Linux"},{string:navigator.userAgent,subString:"Android",identity:"Android"}]}},f={browser:function(){return e.detect()},locale:function(){var a=(navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage).split("-");return{country:a[1].toLowerCase(),lang:a[0].toLowerCase()}},device:function(){var c={screen:{width:screen.width,height:screen.height}},d=b.documentElement,e=b.getElementsByTagName("body")[0];return c.viewport={width:a.innerWidth||d.clientWidth||e.clientWidth,height:a.innerHeight||d.clientHeight||e.clientHeight},c.isTablet=!!navigator.userAgent.match(/(iPad|SCH-I800|xoom|kindle)/i),c.isPhone=!c.isTablet&&!!navigator.userAgent.match(/(iPhone|iPod|blackberry|android 0.5|htc|lg|midp|mmp|mobile|nokia|opera mini|palm|pocket|psp|sgh|smartphone|symbian|treo mini|Playstation Portable|SonyEricsson|Samsung|MobileExplorer|PalmSource|Benq|Windows Phone|Windows Mobile|IEMobile|Windows CE|Nintendo Wii)/i),c.isMobile=c.isTablet||c.isPhone,c},plugins:function(){var a=function(a){if(navigator.plugins){var b,c=0,d=navigator.plugins.length;for(;c<d;c++){b=navigator.plugins[c];if(b&&b.name&&b.name.toLowerCase().indexOf(a)!==-1)return!0}return!1}return void 0};return{flash:a("flash"),silverlight:a("silverlight"),java:a("java"),quicktime:a("quicktime")}},session:function(c,d){var e=null;typeof c=="string"&&(e=g.get_cookie(c));if(e===null){e={visits:1,start:(new Date).getTime(),last_visit:(new Date).getTime(),url:a.location.href,path:a.location.pathname,referrer:b.referrer,referrer_info:g.parse_url(b.referrer),search:{engine:null,query:null}};var f=[{name:"Google",host:"google",query:"q"},{name:"Bing",host:"bing.com",query:"q"},{name:"Yahoo",host:"search.yahoo",query:"p"},{name:"AOL",host:"search.aol",query:"q"},{name:"Ask",host:"ask.com",query:"q"},{name:"Baidu",host:"baidu.com",query:"wd"}],i=f.length,j,k,l=0;for(;l<i;l++)j=f[l],e.referrer_info.host.indexOf(j.host)!==-1&&(e.search.engine=j.name,e.search.query=e.referrer_info.query[j.query],e.search.terms=e.search.query.split(" "));e.search.engine===null&&(k=new RegExp("[?&](?:q|query|term|p|wd|query|text)=([^&]+)"),k=k.exec(b.referrer),k&&(e.search.engine="Unknown",e.search.query=decodeURI(k[1]),e.search.terms=e.search.query.split(" ")))}else e=h.parse(e),e.last_visit=(new Date).getTime(),e.visits++;return typeof c=="string"&&g.set_cookie(c,h.stringify(e),d),e},html5_location:function(){return function(a){navigator.geolocation.getCurrentPosition(function(b){b.source="HTML5",a(b)},function(b){c.gapi_location?f.gapi_location()(a):a({error:!0,source:"HTML5"})})}},gapi_location:function(){return function(b){var d=null;g.get_cookie(c.location_cookie)?b(h.parse(g.get_cookie(c.location_cookie))):(a.gloaderReady=function(){"google"in a&&(a.google.loader.ClientLocation?(a.google.loader.ClientLocation.source="google",b(a.google.loader.ClientLocation)):b({error:!0,source:"google"}),g.set_cookie(c.location_cookie,h.stringify(a.google.loader.ClientLocation),c.location_cookie_timeout*60*60*1e3))},g.embed_script("https://www.google.com/jsapi?callback=gloaderReady"))}},ipinfodb_location:function(b){return function(d){var e=g.get_cookie(c.location_cookie);if(e)return h.parse(e);a.IPInfoReady=function(a){if(a.statusCode==="OK")a.source="IPInfoDB",g.set_cookie(c.location_cookie,h.stringify(a),c.location_cookie*60*60*1e3),d(a);else{if(c.gapi_location)return f.gapi_location()(d);d({error:!0,source:"IPInfoDB",message:a.statusMessage})}},g.embed_script("http://api.ipinfodb.com/v3/ip-city/?key="+b+"&format=json&callback=ipinfocb")}}},g={trim:function(a){return a.replace(/^\s+|\s+$/g,"")},parse_url:function(a){var c,d=b.createElement("a");d.href=a;var c=d.search.substr(1);if(c!==""){var e=c.split("&"),f=split.length,g,h=0;c={};for(;h<f;h++)g=e[h].split("="),g.length===2&&(c[g[0]]=decodeURI(g[1]))}return{host:d.host,path:d.pathname,protocol:d.protocol,port:d.port===""?80:d.port,search:d.search,query:c}},set_cookie:function(a,c,d,e){e=e?"; path="+e:"; path=/";if(d){var f=new Date;f.setTime(f.getTime()+d),d="; expires="+f.toGMTString()}else d="";return b.cookie=a+"="+c+d+e},get_cookie:function(a){var c=b.cookie.split(";"),d,e=0,f=c.length;for(;e<f;e++){d=g.trim(c[e]);if(d.indexOf(a)===0)return d.substr(a.length+1,d.length)}return null},embed_script:function(a){var c=b.createElement("script");c.type="text/javascript",c.src=a,b.getElementsByTagName("body")[0].appendChild(c)}},h={parse:JSON.parse||function(a){return typeof a!="string"||!a?null:(new Function("return "+a))()},stringify:JSON.stringify||function(a){var b=typeof a;if(b==="object"&&a!==null){var c,d,e=[],f=a&&a.constructor===Array;for(c in a)d=a[c],b=typeof d,b==="string"?d='"'+d+'"':b==="object"&&d!==null&&(d=this.stringify(d)),e.push((f?"":'"'+c+'":')+d);return(f?"[":"{")+e.join(",")+(f?"]":"}")}if(b==="string")return'"'+a+'"'}};new d})(window,document)